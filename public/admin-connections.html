<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Logs - Pulse Admin</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* A++ Professional Layout Fixes */
        .admin-table-widget td {
            padding: 20px 15px !important;
            vertical-align: middle;
            border-bottom: 1px solid #e2e8f0; /* Visible row lines */
        }

        .timestamp-box {
            min-width: 100px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .user-badge-container {
            min-width: 180px;
            text-align: left; /* Force Left Alignment */
        }

        .initiator-badge {
            background: #e0f2fe; 
            color: #0369a1;      
            padding: 10px 14px;
            border-radius: 10px;
            display: inline-flex; /* No Float */
            flex-direction: column;
            border: 1px solid #bae6fd;
            width: auto;
            min-width: 160px;
        }

        .recipient-badge {
            background: #f3e8ff; 
            color: #7e22ce;      
            padding: 10px 14px;
            border-radius: 10px;
            display: inline-flex; /* No Float */
            flex-direction: column;
            border: 1px solid #e9d5ff;
            width: auto;
            min-width: 160px;
        }

        .note-container {
            display: flex;
            gap: 12px;
            min-width: 380px; 
        }

        .note-bubble {
            flex: 1;
            font-size: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            min-height: 45px;
            line-height: 1.4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .note-label {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 0.8px;
        }

        .arrow-col {
            text-align: center;
            width: 40px;
            color: #cbd5e1;
            font-size: 20px;
            font-weight: 900;
        }
    </style>
</head>
<body>
    <div id="navPlaceholder"></div>

    <main>
        <div class="admin-dashboard-container">
            
            <div class="admin-header-row">
                <div class="admin-title">
                    <h1 style="margin-bottom: 5px;">Connection History</h1>
                    <p style="color: #64748b; margin: 0;">Audit trail of all QR networking interactions.</p>
                </div>
                <div class="admin-toolbar">
                    <button class="admin-btn-outline" onclick="window.location.href='admin-analytics.html'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                        Back to Analytics
                    </button>
                </div>
            </div>

            <div class="admin-card" style="padding: 15px 25px; margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; position: relative; min-width: 300px;">
                        <input type="text" id="logSearch" placeholder="Search by name, @username, or event..." 
                               style="width: 100%; padding: 12px 15px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                    </div>
                    <select id="eventFilter" style="padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px;">
                        <option value="all">All Events</option>
                    </select>
                </div>
            </div>

            <div class="admin-card" style="border-top: none; border-top-left-radius: 0; border-top-right-radius: 0; padding: 0; overflow-x: auto;">
                <table class="admin-table-widget" style="width: 100%; border-collapse: separate; border-spacing: 0;">
                    <thead>
                        <tr style="background: #f8fafc;">
                            <th style="padding-left: 25px; width: 120px;">Time</th>
                            
                            <th style="text-align: left; padding-left: 15px;">Initiator (Scanner)</th>
                            
                            <th class="arrow-col"></th>
                            
                            <th style="text-align: left; padding-left: 15px;">Recipient (Scanned)</th>
                            
                            <th style="text-align: left; padding-left: 15px;">Event Context</th>
                            
                            <th style="padding-right: 25px;">Qualitative Notes</th>
                        </tr>
                    </thead>
                    <tbody id="connectionsLogBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="js/navLoader.js"></script>
    <script src="js/toggle.js"></script>
    <script>
        let allLogs = [];

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const res = await fetch('/api/admin/all-connections');
                allLogs = await res.json();
                
                // Filter Setup
                const events = [...new Set(allLogs.map(l => l.event_name))];
                const filter = document.getElementById('eventFilter');
                events.forEach(evt => {
                    const opt = document.createElement('option');
                    opt.value = evt; opt.textContent = evt;
                    filter.appendChild(opt);
                });

                renderTable(allLogs);
                document.getElementById('logSearch').addEventListener('input', filterLogs);
                document.getElementById('eventFilter').addEventListener('change', filterLogs);
            } catch (err) { console.error(err); }
        });

        function renderTable(data) {
            const tbody = document.getElementById('connectionsLogBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">No logs found.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(c => `
                <tr>
                    <td data-label="Time" style="padding-left: 25px;">
                        <div class="timestamp-box">
                            <span style="font-weight: 700; color: #1e293b; font-size: 13px;">
                                ${new Date(c.created_at).toLocaleDateString([], {month:'short', day:'numeric'})}
                            </span>
                            <span style="color: #94a3b8; font-size: 11px;">
                                ${new Date(c.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                            </span>
                        </div>
                    </td>
                    
                    <td data-label="Initiator" class="user-badge-container" style="text-align: left;">
                        <div class="initiator-badge" 
                            onclick="window.location.href='admin-user-analytics.html?user=${c.scanner_username}'" 
                            style="cursor: pointer; width: auto; display: inline-flex; align-items: center; gap: 10px; min-width: 160px;">
                            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                                <span style="font-weight: 700;">${c.scanner_name}</span>
                                <span style="font-size: 11px; opacity: 0.7;">@${c.scanner_username}</span>
                            </div>
                        </div>
                    </td>
                    
                    <td class="arrow-col" style="text-align: center; color: #cbd5e1;">âž”</td>
                    
                    <td data-label="Recipient" class="user-badge-container" style="text-align: left;">
                        <div class="recipient-badge" 
                            onclick="window.location.href='admin-user-analytics.html?user=${c.scanned_username}'" 
                            style="cursor: pointer; width: auto; display: inline-flex; align-items: center; gap: 10px; min-width: 160px;">
                            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                                <span style="font-weight: 700;">${c.scanned_name}</span>
                                <span style="font-size: 11px; opacity: 0.7;">@${c.scanned_username}</span>
                            </div>
                        </div>
                    </td>
                    
                    <td data-label="Event" style="text-align: left; padding-left: 15px;">
                        <div style="font-weight: 600; color: #475569; font-size: 13px;">${c.event_name}</div>
                    </td>
                    
                    <td data-label="Notes" style="padding-right: 25px; display:block; width:100%;">
                        <div class="note-container">
                            <div style="flex: 1; margin-bottom:5px;">
                                <div class="note-label" style="color: #0369a1;">Scanner Note</div>
                                <div class="note-bubble">${c.scanner_note || '<em style="color:#cbd5e1">No note</em>'}</div>
                            </div>
                            <div style="flex: 1;">
                                <div class="note-label" style="color: #7e22ce;">Recipient Note</div>
                                <div class="note-bubble" style="border-left: 3px solid #7e22ce;">${c.scanned_note || '<em style="color:#cbd5e1">No note</em>'}</div>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterLogs() {
            const query = document.getElementById('logSearch').value.toLowerCase();
            const eventVal = document.getElementById('eventFilter').value;
            const filtered = allLogs.filter(l => {
                const searchMatch = l.scanner_name.toLowerCase().includes(query) || 
                                    l.scanned_name.toLowerCase().includes(query) || 
                                    l.scanner_username.toLowerCase().includes(query) ||
                                    l.event_name.toLowerCase().includes(query);
                const eventMatch = eventVal === 'all' || l.event_name === eventVal;
                return searchMatch && eventMatch;
            });
            renderTable(filtered);
        }
    </script>
<script src="js/mobile-check.js"></script>
</body>
</html>