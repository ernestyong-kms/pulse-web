<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendee Profile - Pulse</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f4f4f5; padding: 20px; }
        .profile-container { background: white; width: 100%; max-width: 420px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); overflow: hidden; text-align: center; position: relative; animation: slideUp 0.4s ease-out; }
        .profile-header-bg { background: linear-gradient(135deg, #d90429, #8d0801); height: 120px; width: 100%; }
        .profile-avatar { width: 110px; height: 110px; border-radius: 50%; border: 5px solid white; object-fit: cover; margin-top: -55px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .profile-body { padding: 15px 30px 40px; }
        .tag-pill { display: inline-block; background: #f3f4f6; color: #555; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; margin: 3px; }
        .contact-btn { display: block; width: 100%; padding: 14px; margin-top: 15px; border-radius: 14px; text-decoration: none; font-weight: 600; font-size: 14px; transition: transform 0.2s; }
        .btn-primary { background: #d90429; color: white; box-shadow: 0 5px 15px rgba(217, 4, 41, 0.3); }
        .btn-secondary { background: #f0f2f5; color: #333; }
    </style>
</head>
<body>

    <div class="profile-container">
        <div class="profile-header-bg"></div>
        <img id="pPhoto" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="profile-avatar">
        
        <div class="profile-body">
            <h2 id="pName" style="margin: 10px 0 5px; font-size: 24px; font-weight: 700;">Loading...</h2>
            <p id="pRole" style="color: #666; margin: 0; font-size: 14px;">Please wait</p>
            
            <div id="pTags" style="margin: 20px 0;"></div>

            <div id="pQuals" style="margin-bottom: 20px; font-size: 13px; color: #555; background: #fff0f3; padding: 10px; border-radius: 12px; display: none;">
                ðŸŽ“ <span id="pQualsText"></span>
            </div>

            <div style="text-align: left; background: #fafafa; padding: 20px; border-radius: 16px; font-size: 14px; color: #444; border: 1px solid #eee;">
                <div style="margin-bottom: 10px;">ðŸ“§ <span id="pEmail" style="margin-left: 8px;">-</span></div>
                <div style="margin-bottom: 10px;">ðŸ“ž <span id="pNumber" style="margin-left: 8px;">-</span></div>
                <div>ðŸ’¼ <span id="pCompany" style="margin-left: 8px;">-</span></div>
            </div>

            <div style="margin-top: 25px; display: flex; gap: 10px; flex-direction: column;">
                <a id="pLinkedIn" href="#" target="_blank" class="contact-btn btn-primary" style="display: none;">Connect on LinkedIn</a>
                <button onclick="window.close()" class="contact-btn btn-secondary">Close Profile</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const user = params.get('user');
            const eventId = params.get('eventId');

            if (user && eventId) {
                loadProfile(user, eventId);
            } else if (token) {
                try {
                    const res = await fetch(`/qr/resolve/${token}`);
                    const data = await res.json();
                    if (data.success) loadProfile(data.username, data.eventId);
                    else showError("Invalid QR code.");
                } catch (err) { showError("Server error resolving token."); }
            } else {
                showError("No profile data found.");
            }
        });

        async function loadProfile(username, eventId) {
            try {
                const res = await fetch(`/getRegistration/${username}/${eventId}`);
                const data = await res.json();
                if (!data) return showError("Profile not found.");

                document.getElementById("pName").textContent = data.name || "Unknown";
                document.getElementById("pRole").textContent = data.position || "Attendee";
                document.getElementById("pCompany").textContent = data.company || "-";
                document.getElementById("pEmail").textContent = data.email || "-";
                document.getElementById("pNumber").textContent = data.number || "-";
                if (data.photo) document.getElementById("pPhoto").src = data.photo;

                // Tags
                const tagsContainer = document.getElementById("pTags");
                tagsContainer.innerHTML = "";
                const skills = data.skills ? data.skills.split(',') : [];
                const interests = data.specialInterests ? data.specialInterests.split(',') : [];
                [...skills, ...interests].slice(0, 4).forEach(tag => {
                    if(tag.trim()) {
                        const span = document.createElement("span");
                        span.className = "tag-pill";
                        span.textContent = tag.trim();
                        tagsContainer.appendChild(span);
                    }
                });

                // ðŸ”¥ ADDED: Qualifications Logic
                if (data.qualifications) {
                    document.getElementById("pQualsText").textContent = data.qualifications;
                    document.getElementById("pQuals").style.display = "block";
                } else {
                    document.getElementById("pQuals").style.display = "none";
                }

                // LinkedIn
                const linkedInBtn = document.getElementById("pLinkedIn");
                if (data.linkedin) {
                    linkedInBtn.href = data.linkedin.startsWith('http') ? data.linkedin : `https://${data.linkedin}`;
                    linkedInBtn.style.display = "block";
                }

            } catch (err) { showError("Failed to load profile."); }
        }

        function showError(msg) {
            document.querySelector(".profile-body").innerHTML = `<h2 style="color:#d90429;">Oops!</h2><p>${msg}</p><button onclick="window.close()" class="contact-btn btn-secondary" style="margin-top:20px;">Close</button>`;
        }
    </script>

<script src="js/mobile-check.js"></script>
</body>
</html>